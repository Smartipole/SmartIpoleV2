<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ฟอร์มข้อมูลผู้แจ้งซ่อม</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary-color: #f8fafc;
            --accent-color: #10b981;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --border-focus: #3b82f6;
            --bg-primary: #ffffff;
            --bg-secondary: #f1f5f9;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 1.5rem;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .app-container {
            max-width: 480px;
            margin: 0 auto;
            background: var(--bg-primary);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 2.5rem 2rem 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        .header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            position: relative;
            z-index: 1;
        }

        .header p {
            opacity: 0.9;
            font-size: 1rem;
            position: relative;
            z-index: 1;
        }

        .form-container {
            padding: 2.5rem 2rem;
        }

        .notice {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 1px solid #f59e0b;
            border-radius: var(--radius-md);
            padding: 1.25rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            animation: fadeIn 0.8s ease-out 0.2s both;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .notice-icon {
            width: 22px;
            height: 22px;
            color: var(--warning-color);
            flex-shrink: 0;
            margin-top: 2px;
        }

        .notice-text {
            font-size: 0.9rem;
            color: #92400e;
            line-height: 1.6;
        }

        .form-group {
            margin-bottom: 2rem;
            animation: fadeInUp 0.6s ease-out both;
        }

        .form-group:nth-child(1) { animation-delay: 0.1s; }
        .form-group:nth-child(2) { animation-delay: 0.2s; }
        .form-group:nth-child(3) { animation-delay: 0.3s; }
        .form-group:nth-child(4) { animation-delay: 0.4s; }
        .form-group:nth-child(5) { animation-delay: 0.5s; }
        .form-group:nth-child(6) { animation-delay: 0.6s; }
        .form-group:nth-child(7) { animation-delay: 0.7s; }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
            font-size: 1rem;
            transition: color 0.3s ease;
        }

        .required {
            color: var(--error-color);
            margin-left: 3px;
            font-weight: 700;
        }

        .input-container {
            position: relative;
            margin-bottom: 0.5rem;
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 1rem 1.25rem;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-family: inherit;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            appearance: none;
            min-height: 56px;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
            transform: translateY(-1px);
        }

        .form-input:valid:not(:placeholder-shown) {
            border-color: var(--accent-color);
        }

        .form-input::placeholder {
            color: var(--text-secondary);
            transition: opacity 0.3s ease;
            font-size: 0.95rem;
        }

        .form-input:focus::placeholder {
            opacity: 0.6;
        }

        .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 1rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 3rem;
            cursor: pointer;
        }

        .form-select option {
            font-size: 1rem;
            padding: 0.5rem;
        }

        .input-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            width: 1.25rem;
            height: 1.25rem;
            color: var(--text-secondary);
            pointer-events: none;
            transition: color 0.3s ease;
        }

        .form-input:focus + .input-icon {
            color: var(--border-focus);
        }

        /* Adjust padding for inputs with icons */
        .input-container:has(.input-icon) .form-input {
            padding-left: 3rem;
        }

        .submit-btn {
            width: 100%;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border: none;
            padding: 1.25rem 1.5rem;
            border-radius: var(--radius-md);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            margin-top: 1.5rem;
            animation: fadeInUp 0.6s ease-out 0.7s both;
            min-height: 60px;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .submit-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .btn-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            transition: opacity 0.3s ease;
        }

        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
            display: none;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .footer {
            padding: 1.5rem 2rem;
            background: var(--bg-secondary);
            text-align: center;
            font-size: 0.875rem;
            color: var(--text-secondary);
            border-top: 1px solid var(--border-color);
            line-height: 1.8;
        }

        .footer p {
            margin-bottom: 0.5rem;
        }

        .footer p:last-child {
            margin-bottom: 0;
        }

        .success-message,
        .error-message {
            padding: 1.25rem;
            border-radius: var(--radius-md);
            margin: 1.5rem 0;
            font-weight: 500;
            display: none;
            animation: slideDown 0.5s ease-out;
            font-size: 1rem;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .success-message {
            background: #d1fae5;
            border: 2px solid #a7f3d0;
            color: #065f46;
        }

        .error-message {
            background: #fee2e2;
            border: 2px solid #fecaca;
            color: #991b1b;
        }

        .form-group.error .form-input,
        .form-group.error .form-select {
            border-color: var(--error-color);
            background-color: #fef2f2;
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .error-text {
            color: var(--error-color);
            font-size: 0.875rem;
            margin-top: 0.5rem;
            display: none;
            font-weight: 500;
            padding-left: 0.25rem;
        }

        .form-group.error .error-text {
            display: block;
        }

        /* Improved focus states */
        .form-input:focus,
        .form-select:focus {
            border-color: var(--border-focus);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }

        /* Better spacing for phone screens */
        @media (max-width: 480px) {
            body {
                padding: 1rem;
            }
            
            .app-container {
                border-radius: var(--radius-lg);
                max-width: 100%;
            }
            
            .header {
                padding: 2rem 1.5rem 1.5rem;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .header p {
                font-size: 0.9rem;
            }
            
            .form-container {
                padding: 2rem 1.5rem;
            }
            
            .form-group {
                margin-bottom: 1.75rem;
            }
            
            .form-input,
            .form-select {
                padding: 0.875rem 1rem;
                font-size: 16px; /* Prevents zoom on iOS */
                min-height: 52px;
            }
            
            .input-container:has(.input-icon) .form-input {
                padding-left: 2.75rem;
            }
            
            .form-select {
                padding-right: 2.75rem;
            }
            
            .submit-btn {
                padding: 1rem 1.5rem;
                font-size: 1rem;
                min-height: 56px;
            }
            
            .notice {
                padding: 1rem;
                margin-bottom: 1.5rem;
            }
            
            .footer {
                padding: 1.25rem 1.5rem;
                font-size: 0.8rem;
            }
        }

        /* Extra small screens */
        @media (max-width: 360px) {
            .form-container {
                padding: 1.5rem 1rem;
            }
            
            .header {
                padding: 1.5rem 1rem;
            }
            
            .form-input,
            .form-select {
                padding: 0.75rem;
                min-height: 48px;
            }
            
            .input-container:has(.input-icon) .form-input {
                padding-left: 2.5rem;
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #1e293b;
                --bg-secondary: #334155;
                --text-primary: #f1f5f9;
                --text-secondary: #94a3b8;
                --border-color: #475569;
            }
            
            .form-input,
            .form-select {
                background: var(--bg-primary);
                color: var(--text-primary);
            }
            
            .form-group.error .form-input,
            .form-group.error .form-select {
                background-color: #2d1b1b;
            }
        }

        /* Focus visible for accessibility */
        .submit-btn:focus-visible {
            outline: 3px solid rgba(59, 130, 246, 0.5);
            outline-offset: 2px;
        }

        .form-input:focus-visible,
        .form-select:focus-visible {
            outline: 3px solid rgba(59, 130, 246, 0.5);
            outline-offset: 2px;
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .form-input,
            .form-select {
                border-width: 3px;
            }
            
            .form-input:focus,
            .form-select:focus {
                border-width: 3px;
            }
        }

        /* SUCCESS MODAL STYLES (from styles.css, might not be used if successMessage div is used) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-overlay.hide {
            opacity: 0;
            transform: scale(0.9);
        }

        .modal-container {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            margin: 1rem;
            max-width: 400px;
            width: 100%;
            box-shadow: 
                0 25px 50px -12px rgba(0, 0, 0, 0.25),
                0 0 0 1px rgba(255, 255, 255, 0.1);
            transform: translateY(20px) scale(0.95);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal-overlay.show .modal-container {
            transform: translateY(0) scale(1);
        }

        .modal-content {
            text-align: center;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 1.5rem;
            background: linear-gradient(135deg, #10b981, #059669);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: successPulse 0.6s ease-out;
        }

        @keyframes successPulse {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .success-icon svg {
            width: 40px;
            height: 40px;
            color: white;
            stroke-width: 3;
        }

        .modal-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1rem;
            animation: fadeInUp 0.6s ease-out 0.2s both;
        }

        .modal-message {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            line-height: 1.6;
            animation: fadeInUp 0.6s ease-out 0.3s both;
        }

        .modal-submessage {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 2rem;
            opacity: 0.8;
            animation: fadeInUp 0.6s ease-out 0.4s both;
        }

        .countdown-container {
            margin-bottom: 2rem;
            animation: fadeInUp 0.6s ease-out 0.5s both;
        }

        .countdown-circle {
            width: 60px;
            height: 60px;
            margin: 0 auto;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(37, 99, 235, 0);
            }
        }

        .countdown-circle span {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
        }

        .modal-close-btn {
            width: 100%;
            background: linear-gradient(135deg, var(--accent-color), #059669);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: fadeInUp 0.6s ease-out 0.6s both;
        }

        .modal-close-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
        }

        .modal-close-btn:active {
            transform: translateY(0);
        }

        /* Mobile responsive for modal */
        @media (max-width: 480px) {
            .modal-container {
                margin: 1rem;
                padding: 1.5rem;
                border-radius: 16px;
            }
            
            .success-icon {
                width: 70px;
                height: 70px;
                margin-bottom: 1.25rem;
            }
            
            .success-icon svg {
                width: 35px;
                height: 35px;
            }
            
            .modal-title {
                font-size: 1.5rem;
                margin-bottom: 0.75rem;
            }
            
            .modal-message {
                font-size: 1rem;
            }
            
            .modal-submessage {
                font-size: 0.85rem;
                margin-bottom: 1.5rem;
            }
            
            .countdown-circle {
                width: 50px;
                height: 50px;
            }
            
            .countdown-circle span {
                font-size: 1.25rem;
            }
            
            .countdown-container {
                margin-bottom: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>📱 ระบบแจ้งซ่อมไฟฟ้า</h1>
            <p>กรุณากรอกข้อมูลผู้แจ้งให้ครบถ้วน</p>
        </div>

        <div class="form-container">
            <div class="notice">
                <svg class="notice-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                          d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <div class="notice-text">
                    <strong>หมายเหตุ:</strong> กรุณากรอกข้อมูลให้ครบถ้วนและถูกต้อง 
                    เพื่อให้เจ้าหน้าที่สามารถติดต่อกลับได้อย่างรวดเร็ว
                </div>
            </div>

            <div class="success-message" id="successMessage">
                </div>

            <div class="error-message" id="errorMessage">
                </div>

            <form id="userInfoForm" novalidate>
                <input type="hidden" name="formSource" value="vercelUserInfoForm"> <input type="hidden" name="lineUserId" id="lineUserId">

                <div class="form-group">
                    <label for="titlePrefix" class="form-label">
                        คำนำหน้าชื่อ <span class="required">*</span>
                    </label>
                    <div class="input-container">
                        <select name="titlePrefix" id="titlePrefix" class="form-select" required>
                            <option value="">-- เลือกคำนำหน้า --</option>
                            <option value="นาย">นาย</option>
                            <option value="นาง">นาง</option>
                            <option value="นางสาว">นางสาว</option>
                            <option value="เด็กชาย">เด็กชาย</option>
                            <option value="เด็กหญิง">เด็กหญิง</option>
                        </select>
                    </div>
                    <div class="error-text">กรุณาเลือกคำนำหน้าชื่อ</div>
                </div>

                <div class="form-group">
                    <label for="firstName" class="form-label">
                        ชื่อ <span class="required">*</span>
                    </label>
                    <div class="input-container">
                        <input type="text" name="firstName" id="firstName" class="form-input" 
                               placeholder="กรอกชื่อของท่าน" required minlength="2" maxlength="50">
                        <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                    </div>
                    <div class="error-text">กรุณากรอกชื่อ (อย่างน้อย 2 ตัวอักษร)</div>
                </div>

                <div class="form-group">
                    <label for="lastName" class="form-label">
                        นามสกุล <span class="required">*</span>
                    </label>
                    <div class="input-container">
                        <input type="text" name="lastName" id="lastName" class="form-input" 
                               placeholder="กรอกนามสกุลของท่าน" required minlength="2" maxlength="50">
                        <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                    </div>
                    <div class="error-text">กรุณากรอกนามสกุล (อย่างน้อย 2 ตัวอักษร)</div>
                </div>

                <div class="form-group">
                    <label for="phone" class="form-label">
                        เบอร์โทรศัพท์ <span class="required">*</span>
                    </label>
                    <div class="input-container">
                        <input type="tel" name="phone" id="phone" class="form-input" 
                               placeholder="08xxxxxxxx" required pattern="[0-9]{9,10}" maxlength="10">
                        <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                        </svg>
                    </div>
                    <div class="error-text">กรุณากรอกเบอร์โทรศัพท์ 9-10 หลัก</div>
                </div>

                <div class="form-group">
                    <label for="houseNo" class="form-label">
                        บ้านเลขที่ <span class="required">*</span>
                    </label>
                    <div class="input-container">
                        <input type="text" name="houseNo" id="houseNo" class="form-input" 
                               placeholder="เช่น 123, 45/1, 67 หมู่ 2" required maxlength="20">
                        <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                        </svg>
                    </div>
                    <div class="error-text">กรุณากรอกบ้านเลขที่</div>
                </div>

                <div class="form-group">
                    <label for="moo" class="form-label">
                        หมู่บ้าน <span class="required">*</span>
                    </label>
                    <div class="input-container">
                        <select name="moo" id="moo" class="form-select" required>
                            <option value="">-- เลือกหมู่บ้าน --</option>
                            <option value="หมู่ 2 บ้านดอนเข็มเหนือ">หมู่ 2 บ้านดอนเข็มเหนือ</option>
                            <option value="หมู่ 3 บ้านข่าใหญ่">หมู่ 3 บ้านข่าใหญ่</option>
                            <option value="หมู่ 6 บ้านดินทรายอ่อนใต้">หมู่ 6 บ้านดินทรายอ่อนใต้</option>
                            <option value="หมู่ 7 บ้านนาล้อม">หมู่ 7 บ้านนาล้อม</option>
                            <option value="หมู่ 8 บ้านหนองแสงใต้">หมู่ 8 บ้านหนองแสงใต้</option>
                            <option value="หมู่ 10 บ้านดอนหัน">หมู่ 10 บ้านดอนหัน</option>
                            <option value="หมู่ 11 บ้านข่าน้อย">หมู่ 11 บ้านข่าน้อย</option>
                            <option value="หมู่ 12 บ้านดินทรายอ่อนเหนือ">หมู่ 12 บ้านดินทรายอ่อนเหนือ</option>
                            <option value="หมู่ 14 บ้านหนองแสงเหนือ">หมู่ 14 บ้านหนองแสงเหนือ</option>
                            <option value="หมู่ 15 บ้านดอนเข็มใต้">หมู่ 15 บ้านดอนเข็มใต้</option>
                            <option value="หมู่ 16 บ้านทรายทอง">หมู่ 16 บ้านทรายทอง</option>
                            <option value="อื่นๆ/ไม่ทราบ">อื่นๆ/ไม่ทราบ</option>
                        </select>
                    </div>
                    <div class="error-text">กรุณาเลือกหมู่บ้าน</div>
                </div>

                <button type="submit" class="submit-btn" id="submitBtn">
                    <div class="btn-content">
                        <span id="btnText">💾 บันทึกข้อมูล</span>
                        <div class="loading-spinner" id="loadingSpinner"></div>
                    </div>
                </button>
            </form>
        </div>

        <div class="footer">
            <p>🔒 ข้อมูลของท่านได้รับการปกป้องอย่างปลอดภัย</p>
            <p>หากมีปัญหา กรุณาติดต่อเจ้าหน้าที่</p>
        </div>
    </div>

    <script>
        // =================================================================================
        // CONFIGURATION
        // =================================================================================
        // 🔥 เปลี่ยนเป็น URL ของ Google Apps Script Web App ของคุณ
        const GAS_WEBHOOK_URL = 'https://script.google.com/macros/s/AKfycbz0P-vROC8-ahiIFzJJUuH-zc-d767APL_RcAk9yA_WRb2uDk0IW1qwLKozK6AqH8iC5Q/exec'; // <--- ตรวจสอบและใส่ URL ที่ถูกต้อง

        // =================================================================================
        // DOM ELEMENTS
        // =================================================================================
        const form = document.getElementById('userInfoForm');
        const submitBtn = document.getElementById('submitBtn');
        const btnText = document.getElementById('btnText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const successMessageDiv = document.getElementById('successMessage'); // Changed variable name for clarity
        const errorMessageDiv = document.getElementById('errorMessage'); // Changed variable name for clarity

        // =================================================================================
        // INITIALIZATION
        // =================================================================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Script initialization started');
            
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('userId');
            
            console.log('📊 URL Parameters:', {
                fullURL: window.location.href,
                search: window.location.search,
                userId: userId
            });
            
            if (userId) {
                document.getElementById('lineUserId').value = userId;
                console.log('✅ User ID set:', userId);
            } else {
                console.warn('⚠️ No userId found in URL parameters. Form might not submit correctly.');
                // Consider showing an error to the user if userId is critical and missing
                showError('ไม่พบ User ID ในระบบ กรุณาเปิดฟอร์มนี้ผ่านทาง LINE อีกครั้ง');
                if(submitBtn) submitBtn.disabled = true;
            }

            console.log('🔗 GAS Webhook URL:', GAS_WEBHOOK_URL);
            if (!GAS_WEBHOOK_URL || GAS_WEBHOOK_URL.includes('YOUR_ACTUAL_GAS_URL_HERE') || GAS_WEBHOOK_URL.length < 50) { // Basic check
                console.error('❌ GAS_WEBHOOK_URL not configured or looks incorrect! Please update the URL in the script.');
                showError('ระบบยังไม่ได้ตั้งค่าการเชื่อมต่อ กรุณาติดต่อผู้ดูแลระบบ');
                if(submitBtn) submitBtn.disabled = true;
            }

            initializeFormValidation();
            initializeFormSubmission();
            
            console.log('✅ Form initialized successfully');
        });

        // =================================================================================
        // FORM VALIDATION
        // =================================================================================
        function initializeFormValidation() {
            if (!form) return;
            const inputs = form.querySelectorAll('input[required], select[required]');
            
            inputs.forEach(input => {
                input.addEventListener('blur', validateField);
                input.addEventListener('input', clearFieldError);
                
                if (input.name === 'phone') {
                    input.addEventListener('input', function(e) {
                        e.target.value = e.target.value.replace(/[^0-9]/g, '');
                        if (e.target.value.length > 10) {
                            e.target.value = e.target.value.slice(0, 10);
                        }
                    });
                }
            });
        }

        function validateField(e) {
            const field = e.target;
            const formGroup = field.closest('.form-group');
            if (!formGroup) return true; // Should not happen if structure is correct

            let isValid = true;
            formGroup.classList.remove('error');

            if (field.required && !field.value.trim()) {
                isValid = false;
            }

            if (isValid) { // Only proceed with specific validation if basic requirement is met
                switch (field.name) {
                    case 'titlePrefix':
                        if (!field.value) isValid = false;
                        break;
                    case 'firstName':
                    case 'lastName':
                        if (field.value.trim().length < 2) isValid = false;
                        break;
                    case 'phone':
                        const phonePattern = /^[0-9]{9,10}$/;
                        if (!phonePattern.test(field.value)) isValid = false;
                        break;
                    case 'houseNo': // Assuming houseNo is required
                        if (!field.value.trim()) isValid = false;
                        break;
                    case 'moo':
                        if (!field.value) isValid = false;
                        break;
                }
            }

            if (!isValid) {
                formGroup.classList.add('error');
            }
            return isValid;
        }

        function clearFieldError(e) {
            const field = e.target;
            const formGroup = field.closest('.form-group');
            if (formGroup) {
                 formGroup.classList.remove('error');
            }
        }

        function validateAllFields() {
            if (!form) return false;
            const inputs = form.querySelectorAll('input[required], select[required]');
            let isFormValid = true;
            
            inputs.forEach(input => {
                if (!validateField({ target: input })) {
                    isFormValid = false;
                }
            });
            return isFormValid;
        }

        // =================================================================================
        // FORM SUBMISSION
        // =================================================================================
        function initializeFormSubmission() {
            if (form) {
                form.addEventListener('submit', handleFormSubmission);
            }
        }

        async function handleFormSubmission(e) {
            e.preventDefault();
            console.log('📝 Form submission started');
            
            hideMessages();
            
            if (!GAS_WEBHOOK_URL || GAS_WEBHOOK_URL.includes('YOUR_ACTUAL_GAS_URL_HERE') || GAS_WEBHOOK_URL.length < 50) {
                console.error('❌ GAS URL not configured for submission');
                showError('ระบบยังไม่ได้ตั้งค่าการเชื่อมต่อ กรุณาติดต่อผู้ดูแลระบบ');
                return;
            }
            
            if (!validateAllFields()) {
                console.warn('⚠️ Form validation failed');
                showError('กรุณากรอกข้อมูลให้ครบถ้วนและถูกต้องทุกช่อง');
                return;
            }
            
            const userIdInput = document.getElementById('lineUserId');
            if (!userIdInput || !userIdInput.value) {
                console.warn('⚠️ No User ID found for submission');
                showError('ไม่พบ User ID กรุณาเปิดฟอร์มผ่าน LINE อีกครั้ง');
                return;
            }
            
            setLoadingState(true);
            
            try {
                const formData = new FormData(form);
                // formData.append('formSource', 'vercelUserInfoForm'); // Already in HTML, but can be set here too
                
                const formDataObj = Object.fromEntries(formData.entries());
                console.log('📊 Form data to send:', formDataObj);
                
                const params = new URLSearchParams();
                for (const pair of formData.entries()) {
                    params.append(pair[0], pair[1]);
                }
                console.log('📤 Request payload (URLSearchParams):', params.toString());

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 seconds timeout

                const response = await fetch(GAS_WEBHOOK_URL, {
                    method: 'POST',
                    mode: 'cors', // Important for cross-origin requests
                    cache: 'no-cache',
                    headers: {
                        // 'Content-Type': 'application/json', // GAS expects x-www-form-urlencoded for e.parameter
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: params.toString(), // Send as URL encoded string
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                console.log('📥 Response received: Status', response.status);
                const responseText = await response.text();
                console.log('📄 Raw response text:', responseText);

                if (!response.ok) {
                    // Try to parse error message if server sends JSON error
                    try {
                        const errorData = JSON.parse(responseText);
                        throw new Error(errorData.message || `HTTP error ${response.status}`);
                    } catch (e) {
                        throw new Error(`HTTP error ${response.status}: ${responseText || response.statusText}`);
                    }
                }
                
                const data = JSON.parse(responseText);
                console.log('✅ Parsed JSON response:', data);
                
                if (data.status === 'success') {
                    console.log('🎉 Form submission successful');
                    // Display the success message from GAS, or a default one
                    handleSuccessResponse(data.message || 'บันทึกข้อมูลเรียบร้อยแล้ว');
                } else {
                    console.error('❌ Server returned error status:', data);
                    throw new Error(data.message || 'เกิดข้อผิดพลาดในการประมวลผลข้อมูล');
                }
                
            } catch (error) {
                console.error('💥 Form submission error:', error);
                let displayMsg = 'เกิดข้อผิดพลาดในการส่งข้อมูล: ';
                if (error.name === 'AbortError') {
                    displayMsg += 'การเชื่อมต่อหมดเวลา';
                } else if (error.message.includes('Failed to fetch')) {
                    displayMsg += 'ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้';
                } else {
                    displayMsg += error.message;
                }
                handleErrorResponse(displayMsg);
            } finally {
                setLoadingState(false);
            }
        }

        function handleSuccessResponse(message) {
            console.log('✅ Handling success response:', message);
            if (successMessageDiv) {
                successMessageDiv.textContent = '✅ ' + message + " กรุณากลับไปที่ LINE เพื่อดำเนินการต่อ หรือพิมพ์ 'แจ้งซ่อม' อีกครั้งหากต้องการเริ่มขั้นตอนการแจ้งปัญหา";
                successMessageDiv.style.display = 'block';
            }
            if (form) form.style.display = 'none'; // Hide form on success

            // Auto redirect or close after a few seconds
            setTimeout(() => {
                console.log('🔄 Closing/Redirecting...');
                redirectToLine();
            }, 5000); // Increased timeout to allow user to read message
        }

        function handleErrorResponse(message) {
            console.error('❌ Handling error response:', message);
            showError(message);
        }

        // =================================================================================
        // UI HELPER FUNCTIONS
        // =================================================================================
        function setLoadingState(isLoading) {
            if (submitBtn) submitBtn.disabled = isLoading;
            if (btnText && loadingSpinner) {
                if (isLoading) {
                    btnText.style.display = 'none';
                    loadingSpinner.style.display = 'block';
                } else {
                    btnText.style.display = 'inline';
                    loadingSpinner.style.display = 'none';
                }
            }
        }

        function showError(message) {
            console.error('🚨 Showing error on page:', message);
            if (errorMessageDiv) {
                errorMessageDiv.textContent = '❌ ' + message;
                errorMessageDiv.style.display = 'block';
                // Auto hide after 8 seconds
                setTimeout(() => {
                    errorMessageDiv.style.display = 'none';
                }, 8000);
            }
        }

        function hideMessages() {
            if (successMessageDiv) successMessageDiv.style.display = 'none';
            if (errorMessageDiv) errorMessageDiv.style.display = 'none';
        }

        function redirectToLine() {
            console.log('🔄 Attempting to redirect/close for LINE');
            // Try to close the window (works if opened by script from LINE)
            try {
                window.close();
                // If window.close() doesn't work (e.g. not opened by script),
                // try redirecting to a LINE scheme URL which might prompt user to open LINE
                // This is a fallback and might not always work depending on browser/OS security.
                setTimeout(() => {
                    window.location.href = 'line://ti/p/@YOUR_LINE_OA_ID'; // Replace @YOUR_LINE_OA_ID with your actual OA ID if known
                    // If that fails, a generic LINE page
                    setTimeout(() => {
                         window.location.href = 'https://line.me/';
                    }, 1000);
                }, 500);

            } catch (e) {
                console.log('❌ Cannot close window or redirect effectively:', e.message);
                // As a last resort, inform the user to manually return to LINE
                if (successMessageDiv && successMessageDiv.style.display === 'block') {
                    successMessageDiv.innerHTML += "<br>กรุณากลับไปที่แอปพลิเคชัน LINE ด้วยตนเอง";
                } else {
                     showError("กรุณากลับไปที่แอปพลิเคชัน LINE ด้วยตนเองเพื่อดำเนินการต่อ");
                }
            }
        }
        
        // =================================================================================
        // ERROR HANDLING & DEBUGGING
        // =================================================================================
        window.addEventListener('error', function(e) {
            console.error('🚨 Global error caught:', {
                message: e.message,
                filename: e.filename,
                lineno: e.lineno,
                colno: e.colno,
                error: e.error
            });
            showError('เกิดข้อผิดพลาดบางอย่างในหน้าเว็บนี้');
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('🚨 Unhandled promise rejection:', e.reason);
            showError('เกิดข้อผิดพลาดในการประมวลผลบางอย่าง');
        });

    </script>
</body>
</html>
